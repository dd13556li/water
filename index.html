<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>濾心管理系統</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css" integrity="sha512-..." crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    body { font-family: Arial, sans-serif; background-color: #f9f9f9; padding: 20px; color: #333; }
    h1 { text-align: center; color: #34495e; }
    table { width: 90%; margin: auto; border-collapse: collapse; box-shadow: 0 2px 8px rgba(0,0,0,0.1); background-color: #fff; }
    th, td { padding: 12px 15px; border: 1px solid #eaeaea; text-align: center; }
    thead th { background-color: #3498db; color: #fff; font-size: 1.1em; }
    .filter-img { width: 50px; height: 50px; object-fit: contain; margin-right: 10px; }
    button { background-color: #3498db; color: #fff; padding: 8px; border: none; cursor: pointer; }
  </style>
</head>
<body>
  <h1>濾心管理系統</h1>

  <table>
    <thead>
      <tr>
        <th>濾心名稱</th>
        <th>上次更換日期</th>
        <th>剩餘壽命 (天)</th>
        <th>到期日期</th>
        <th>操作</th>
      </tr>
      <tr id="new-filter-row">
        <td>
          <select id="filter-type" onchange="updateFilterImage()">
            <option value="UF-591">UF-591 - 5微米PP濾芯</option>
            <option value="UF-592">UF-592 - 塊狀活性碳濾芯</option>
            <option value="UF-593">UF-593 - 1微米PP濾芯</option>
            <option value="UF-504">UF-504 - 逆滲透薄膜</option>
            <option value="UF-515">UF-515 - 椰殼顆粒活性碳濾芯</option>
          </select>
          <img id="filter-img-preview" src="591.png" alt="Filter Image" class="filter-img">
        </td>
        <td><input type="date" id="filter-date"></td>
        <td>
          <select id="filter-lifespan">
            <option value="90">3個月</option>
            <option value="180">6個月</option>
            <option value="365">1年</option>
            <option value="730">2年</option>
          </select>
        </td>
        <td><input type="text" id="filter-expiration" disabled></td>
        <td><button onclick="addFilter()">新增</button></td>
      </tr>
    </thead>
    <tbody id="filter-list">
      <!-- 後端取得的濾心資料將動態插入 -->
    </tbody>
  </table>

  <script>
    const apiBaseUrl = "https://water-2hc2.onrender.com";

    function getFilterImageUrl(type) {
      const cleanType = type.trim().toUpperCase();
      return {
        "UF-591": "591.png",
        "UF-592": "592.png",
        "UF-593": "593.png",
        "UF-504": "504.png",
        "UF-515": "515.png"
      }[cleanType] || "placeholder.png";
    }

    function updateFilterImage() {
      const filterType = document.getElementById("filter-type").value;
      document.getElementById("filter-img-preview").src = getFilterImageUrl(filterType);
    }

    function updateExpirationDate() {
      const dateValue = document.getElementById("filter-date").value;
      const lifespanValue = document.getElementById("filter-lifespan").value;
      const expirationField = document.getElementById("filter-expiration");
      if (dateValue && lifespanValue) {
        let dt = new Date(dateValue);
        dt.setDate(dt.getDate() + Number(lifespanValue));
        expirationField.value = dt.toISOString().split('T')[0];
      } else {
        expirationField.value = "";
      }
    }

    document.getElementById("filter-date").addEventListener('input', updateExpirationDate);
    document.getElementById("filter-lifespan").addEventListener('change', updateExpirationDate);

    function fetchFilters() {
      fetch(`${apiBaseUrl}/filters`)
        .then(response => response.json())
        .then(data => {
          const filterList = document.getElementById("filter-list");
          filterList.innerHTML = "";

          data.forEach(filter => {
            const tr = document.createElement("tr");

            let lastReplaceDate = new Date(filter.last_replace);
            let expirationDate = new Date(lastReplaceDate);
            expirationDate.setDate(lastReplaceDate.getDate() + Number(filter.lifespan));

            let today = new Date();
            let remainingDays = Math.max(0, Math.ceil((expirationDate - today) / (1000 * 60 * 60 * 24)));

            const tdName = document.createElement("td");
            const img = document.createElement("img");
            img.src = getFilterImageUrl(filter.name);
            img.className = "filter-img";
            tdName.appendChild(img);
            tdName.appendChild(document.createTextNode(" " + filter.name));
            tr.appendChild(tdName);

            tr.appendChild(createCell(filter.last_replace));
            tr.appendChild(createCell(`${remainingDays} 天`));
            tr.appendChild(createCell(expirationDate.toISOString().split('T')[0]));

            const tdOps = document.createElement("td");
            tdOps.appendChild(createButton("更新", () => updateFilter(filter.name)));
            tdOps.appendChild(createButton("刪除", () => deleteFilter(filter.name)));
            tr.appendChild(tdOps);

            filterList.appendChild(tr);
          });
        })
        .catch(error => console.error("取得濾心資料失敗:", error));
    }

    function createCell(value) {
      const td = document.createElement("td");
      td.textContent = value;
      return td;
    }

    function createButton(label, action) {
      const btn = document.createElement("button");
      btn.textContent = label;
      btn.onclick = action;
      return btn;
    }

    document.addEventListener("DOMContentLoaded", fetchFilters);
  </script>
</body>
</html>
