<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>濾心管理系統</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css" />
  <style>
    body { 
      font-family: 'Segoe UI', 'Roboto', Arial, sans-serif; 
      background-color: #f0f2f5; 
      padding: 20px; 
      color: #333; 
      line-height: 1.6;
    }
    h1 { 
      text-align: center; 
      color: #2c3e50; 
      margin-bottom: 30px;
    }
    h1 .fas {
      margin-right: 10px;
      color: #3498db;
    }
    table { 
      width: 95%; 
      margin: auto; 
      border-collapse: collapse; 
      box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
      background-color: #fff; 
      border-radius: 8px;
      overflow: hidden; /* For border-radius to apply to th/td */
    }
    th, td { 
      padding: 15px 18px; 
      border-bottom: 1px solid #ecf0f1; 
      text-align: center; 
      vertical-align: middle;
    }
    thead th { 
      background-color: #3498db; 
      color: #fff; 
      font-size: 1.1em;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    /* Remove border from last row of td in tbody */
    tbody tr:last-child td {
      border-bottom: none;
    }

    .filter-img { 
      width: 50px; 
      height: 50px; 
      object-fit: contain; 
      margin-right: 10px; 
      vertical-align: middle;
      border-radius: 4px;
      background-color: #f8f9fa;
      padding: 3px;
      border: 1px solid #dee2e6;
    }
    #filter-img-preview {
        margin-left: 10px; /* Add some space next to select */
    }

    button { 
      background-color: #3498db; 
      color: #fff; 
      padding: 10px 15px; 
      border: none; 
      cursor: pointer; 
      border-radius: 5px;
      font-size: 0.9em;
      transition: background-color 0.3s ease, transform 0.2s ease;
      margin: 0 5px; /* Add some space between buttons */
    }
    button:hover { 
      background-color: #2980b9;
      transform: translateY(-1px);
    }
    button .fas {
      margin-right: 8px;
    }
    #new-filter-row button {
      background-color: #2ecc71; /* Green for add */
    }
    #new-filter-row button:hover {
      background-color: #27ae60;
    }
    .btn-update { background-color: #f39c12; /* Orange for update */ }
    .btn-update:hover { background-color: #e67e22; }
    .btn-delete { background-color: #e74c3c; /* Red for delete */ }
    .btn-delete:hover { background-color: #c0392b; }

    select, input[type="date"], input[type="text"] {
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
      font-size: 0.95em;
      min-width: 150px;
    }
    #new-filter-row td {
      vertical-align: middle;
    }
    #new-filter-row td > * { /* Direct children of td in add row */
        margin-right: 5px;
    }
    #new-filter-row td > *:last-child {
        margin-right: 0;
    }


    /* Row status colors */
    .status-warning td {
      background-color: #fffbe6 !important; /* Light yellow */
      color: #8a6d3b;
    }
    .status-expired td {
      background-color: #fdecea !important; /* Light red */
      color: #a94442;
    }
    .status-expired .remaining-days, .status-warning .remaining-days {
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1><i class="fas fa-filter"></i>濾心管理系統</h1>

  <table>
    <thead>
      <tr>
        <th>濾心名稱</th>
        <th>上次更換日期</th>
        <th>剩餘壽命</th>
        <th>到期日期</th>
        <th>操作</th>
      </tr>
      <tr id="new-filter-row">
        <td>
          <select id="filter-type" onchange="updateFilterImagePreview(); updateNewFilterExpirationPreview();">
            <option value="UF-591">UF-591 - 5微米PP濾芯</option>
            <option value="UF-592">UF-592 - 塊狀活性碳濾芯</option>
            <option value="UF-593">UF-593 - 1微米PP濾芯</option>
            <option value="UF-504">UF-504 - 逆滲透薄膜</option>
            <option value="UF-515">UF-515 - 椰殼顆粒活性碳濾芯</option>
          </select>
          <img id="filter-img-preview" src="591.png" alt="Filter Image" class="filter-img">
        </td>
        <td><input type="date" id="filter-date" onchange="updateNewFilterExpirationPreview()"></td>
        <td>
          <select id="filter-lifespan" onchange="updateNewFilterExpirationPreview()">
            <option value="90">3個月</option>
            <option value="180">6個月</option>
            <option value="365">1年</option>
            <option value="730">2年</option>
          </select>
        </td>
        <td><input type="text" id="filter-expiration" disabled placeholder="自動計算"></td>
        <td><button onclick="addFilter()"><i class="fas fa-plus-circle"></i>新增</button></td>
      </tr>
    </thead>
    <tbody id="filter-list">
      </tbody>
  </table>

  <script>
    const apiBaseUrl = "https://water-2hc2.onrender.com";

    // 濾心詳細資訊，用於名稱顯示和圖片路徑
    const filterDetails = {
      "UF-591": { name: "UF-591 - 5微米PP濾芯", img: "591.png" },
      "UF-592": { name: "UF-592 - 塊狀活性碳濾芯", img: "592.png" },
      "UF-593": { name: "UF-593 - 1微米PP濾芯", img: "593.png" },
      "UF-504": { name: "UF-504 - 逆滲透薄膜", img: "504.png" },
      "UF-515": { name: "UF-515 - 椰殼顆粒活性碳濾芯", img: "515.png" }
    };

    // 根據型號獲取圖片 URL
    function getFilterImageUrl(modelNumber) {
      const model = modelNumber.trim().toUpperCase();
      return (filterDetails[model] && filterDetails[model].img) || "default.png"; // 如果沒有對應圖片則顯示預設
    }

    // 根據型號獲取顯示名稱
    function getFilterDisplayName(modelNumber) {
      const model = modelNumber.trim().toUpperCase();
      return (filterDetails[model] && filterDetails[model].name) || modelNumber;
    }

    // 更新新增濾心行的圖片預覽
    function updateFilterImagePreview() {
      const filterType = document.getElementById("filter-type").value;
      document.getElementById("filter-img-preview").src = getFilterImageUrl(filterType);
    }
    
    // 更新新增濾心行的到期日期預覽
    function updateNewFilterExpirationPreview() {
        const dateInput = document.getElementById("filter-date");
        const lifespanSelect = document.getElementById("filter-lifespan");
        const expirationInput = document.getElementById("filter-expiration");

        if (dateInput.value && lifespanSelect.value) {
            try {
                // 使用 "T00:00:00" 確保日期解析為本地時間的午夜，避免時區問題
                let lastReplaceDate = new Date(dateInput.value + "T00:00:00"); 
                if (isNaN(lastReplaceDate.getTime())) { // 檢查日期是否有效
                    expirationInput.value = "日期無效";
                    return;
                }
                let lifespanDays = parseInt(lifespanSelect.value);
                let expirationDate = new Date(lastReplaceDate);
                expirationDate.setDate(lastReplaceDate.getDate() + lifespanDays);
                // 格式化為 YYYY-MM-DD 顯示
                expirationInput.value = expirationDate.toISOString().split('T')[0];
            } catch (e) {
                expirationInput.value = "計算錯誤";
                console.error("Error calculating expiration date:", e);
            }
        } else {
            expirationInput.value = ""; // 清空預覽
        }
    }

    // 核心功能：獲取濾心資料並顯示在網頁上
    function fetchFilters() {
      fetch(`${apiBaseUrl}/filters`)
        .then(response => {
            if (!response.ok) { // 檢查 HTTP 響應狀態碼
                return response.json().then(errorData => {
                    throw new Error(errorData.message || '網路回應不正確');
                });
            }
            return response.json();
        })
        .then(data => {
          console.log("API 回傳資料:", data);
          const filterList = document.getElementById("filter-list");
          filterList.innerHTML = ""; // 清空現有列表

          // 獲取當前日期 (今天的日期)，用於計算剩餘壽命
          const today = new Date();
          today.setHours(0,0,0,0); // 正規化為當天開始，確保計算準確

          if (Array.isArray(data)) {
            data.forEach(filter => {
              const tr = document.createElement("tr");

              // 將上次更換日期轉換為 Date 物件
              let lastReplaceDate = new Date(filter.last_replace + "T00:00:00"); 
              if (isNaN(lastReplaceDate.getTime())) {
                console.error(`無效的上次更換日期: ${filter.last_replace}`);
                lastReplaceDate = today; // 設為今天以避免崩潰
              }

              // 計算到期日期
              let expirationDate = new Date(lastReplaceDate);
              expirationDate.setDate(lastReplaceDate.getDate() + Number(filter.lifespan));

              // 計算剩餘天數 (當前日期到到期日期的天數)
              let remainingDays = Math.ceil((expirationDate.getTime() - today.getTime()) / (1000 * 60 * 60 * 24));
              remainingDays = Math.max(0, remainingDays); // 確保不顯示負數，最低為 0

              // 根據剩餘天數添加 CSS 類別來改變行顏色
              if (remainingDays <= 0) {
                tr.classList.add("status-expired"); // 已過期
              } else if (remainingDays < 30) {
                tr.classList.add("status-warning"); // 即將到期 (剩餘不到 30 天)
              }

              // 濾心名稱 (包含圖片和顯示名稱)
              const tdName = document.createElement("td");
              const img = document.createElement("img");
              img.src = getFilterImageUrl(filter.name.trim()); // 濾心名稱預期為型號
              img.alt = getFilterDisplayName(filter.name.trim());
              img.className = "filter-img";
              tdName.appendChild(img);
              tdName.appendChild(document.createTextNode(" " + getFilterDisplayName(filter.name.trim())));
              tr.appendChild(tdName);

              // 上次更換日期
              tr.appendChild(createCell(filter.last_replace));
              
              // 剩餘壽命
              const remainingDaysCell = createCell(`${remainingDays} 天`);
              remainingDaysCell.classList.add("remaining-days"); // 添加類名以便 CSS 樣式化
              tr.appendChild(remainingDaysCell);
              
              // 到期日期
              tr.appendChild(createCell(expirationDate.toISOString().split('T')[0])); // 格式化為 YYYY-MM-DD

              // 操作按鈕
              const tdOps = document.createElement("td");
              // 注意：這裡直接將 filter.name (型號) 傳遞給函數
              tdOps.appendChild(createButtonWithIcon("更新", "fas fa-sync-alt", () => updateFilter(filter.name), "btn-update"));
              tdOps.appendChild(createButtonWithIcon("刪除", "fas fa-trash-alt", () => deleteFilter(filter.name), "btn-delete"));
              tr.appendChild(tdOps);

              filterList.appendChild(tr);
            });
          } else {
            console.error("API 回傳資料格式不正確，預期為陣列:", data);
            filterList.innerHTML = `<tr><td colspan="5" style="color: red;">載入濾心資料失敗：伺服器回應格式不正確。</td></tr>`;
          }
        })
        .catch(error => {
          console.error("取得濾心資料失敗:", error);
          const filterList = document.getElementById("filter-list");
          filterList.innerHTML = `<tr><td colspan="5" style="color: red;">載入濾心資料失敗：${error.message || '請檢查網絡或伺服器。'}</td></tr>`;
        });
    }

    // 新增濾心
    function addFilter() {
      // 從 select 元素獲取濾心型號作為名稱
      const name = document.getElementById("filter-type").value.trim(); 
      const lastReplace = document.getElementById("filter-date").value;
      const lifespan = parseInt(document.getElementById("filter-lifespan").value);

      if (!lastReplace) {
        alert("請選擇上次更換日期！");
        return;
      }
      if (!name) {
        alert("請選擇濾心類型！");
        return;
      }
      if (isNaN(lifespan)) {
        alert("請選擇有效的濾心壽命！");
        return;
      }

      fetch(`${apiBaseUrl}/add`, { 
        method: "POST", 
        headers: { "Content-Type": "application/json" }, 
        body: JSON.stringify({ name, last_replace: lastReplace, lifespan }) 
      })
        .then(response => {
          if (!response.ok) { // 處理 HTTP 錯誤
            return response.json().then(errorData => {
                throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
            });
          }
          return response.json();
        })
        .then(data => {
          console.log("新增結果:", data);
          alert(data.message || "濾心已成功新增!");
          // 清空新增表單欄位
          document.getElementById("filter-date").value = "";
          document.getElementById("filter-expiration").value = "";
          // 可以選擇將濾心類型和壽命重置為預設值
          // document.getElementById("filter-type").selectedIndex = 0;
          // document.getElementById("filter-lifespan").selectedIndex = 0;
          // updateFilterImagePreview(); 
          // updateNewFilterExpirationPreview(); 
          fetchFilters(); // 重新載入濾心列表
        })
        .catch(error => {
          console.error("新增失敗:", error);
          alert(`新增失敗: ${error.message}`);
        });
    }

    // 更新濾心的更換日期為今天
    function updateFilter(filterModelName) { 
      if (!confirm(`確定要將濾心 "${getFilterDisplayName(filterModelName)}" 的更換日期更新為今天嗎？`)) {
        return;
      }
      fetch(`${apiBaseUrl}/update`, { 
        method: "POST", 
        headers: { "Content-Type": "application/json" }, 
        body: JSON.stringify({ name: filterModelName }) 
      })
        .then(response => {
          if (!response.ok) {
            return response.json().then(errorData => {
                throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
            });
          }
          return response.json();
        })
        .then(data => {
            console.log("更新結果:", data);
            alert(data.message || "濾心已成功更新!");
            fetchFilters(); // 重新載入濾心列表
        })
        .catch(error => {
            console.error("更新失敗:", error);
            alert(`更新失敗: ${error.message}`);
        });
    }

    // 刪除濾心
    function deleteFilter(filterModelName) { 
      if (!confirm(`確定要刪除濾心 "${getFilterDisplayName(filterModelName)}" 嗎？此操作無法復原。`)) {
        return;
      }
      fetch(`${apiBaseUrl}/delete`, { 
        method: "POST", 
        headers: { "Content-Type": "application/json" }, 
        body: JSON.stringify({ name: filterModelName }) 
      })
        .then(response => {
          if (!response.ok) {
            return response.json().then(errorData => {
                throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
            });
          }
          return response.json();
        })
        .then(data => {
            console.log("刪除結果:", data);
            alert(data.message || "濾心已成功刪除!");
            fetchFilters(); // 重新載入濾心列表
        })
        .catch(error => {
            console.error("刪除失敗:", error);
            alert(`刪除失敗: ${error.message}`);
        });
    }

    // 輔助函數：創建表格單元格
    function createCell(value) { 
      const td = document.createElement("td"); 
      td.textContent = value; 
      return td; 
    }

    // 輔助函數：創建帶圖示的按鈕
    function createButtonWithIcon(label, iconClass, action, btnClass = "") {
      const btn = document.createElement("button");
      const icon = document.createElement("i");
      icon.className = iconClass; 

      btn.appendChild(icon);
      btn.appendChild(document.createTextNode(label));
      btn.onclick = action; // 設定點擊事件
      if (btnClass) {
        btn.classList.add(btnClass); // 添加樣式類別
      }
      return btn;
    }
    
    // 頁面載入完成時執行
    document.addEventListener("DOMContentLoaded", () => {
        fetchFilters(); // 載入所有濾心資料
        updateFilterImagePreview(); // 設定新增行的預設圖片
        // 設定今天的日期為預設的上次更換日期 (HTML input type="date" 的預設值)
        document.getElementById("filter-date").value = new Date().toISOString().split('T')[0];
        updateNewFilterExpirationPreview(); // 計算並顯示預設的到期日期

        // 為新增行的日期和壽命選擇器添加事件監聽器，即時更新到期日期預覽
        document.getElementById("filter-date").addEventListener("change", updateNewFilterExpirationPreview);
        document.getElementById("filter-lifespan").addEventListener("change", updateNewFilterExpirationPreview);
        document.getElementById("filter-type").addEventListener("change", () => {
            updateFilterImagePreview(); // 濾心類型改變時更新圖片
            // updateNewFilterExpirationPreview(); // 濾心類型不影響到期日期計算，故不需在此呼叫
        });
    });
  </script>
</body>
</html>
